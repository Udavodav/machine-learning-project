# Эксперименты по предсказанию оттока клиентов телеком-компании

## Сетка экспериментов

### 1. Наборы данных

| Набор данных | Баланс классов | Описание |
|--------------|-----------------------------|----------------|----------|
| **Unbalanced** | Оригинальный (~27% positive) | Оригинальное распределение классов |
| **Balanced Medium** | Средне-сбалансированный (~50% positive) | Умеренный oversampling миноритарного класса |
| **Balanced** | Полностью сбалансированный (50/50) | Полный баланс через агрессивный oversampling |

### 2. Методы и модели

#### 2.1 Алгоритмы
- **Random Forest** с оптимизацией гиперпараметров через Optuna
- **Gradient Boosting** с оптимизацией гиперпараметров через Optuna
- **LightGBM** с оптимизацией гиперпараметров через Optuna
- **CatBoost** с оптимизацией гиперпараметров через Optuna
- **Ансамбли**: Voting (RF + GB) и Stacking (LR + RF)

#### 2.2 Стратегии валидации
- **Кросс-валидация**: 5-fold Stratified K-Fold
- **Сплит для калибровки**: 80/20 (train/val)
- **Финальная оценка**: Hold-out test set (1,407 samples)

#### 2.3 Метрики оценки
- Основная метрика: **PR-AUC** (для выбора лучшей модели)
- Дополнительные метрики: ROC-AUC, F1-Score, Precision, Recall, Accuracy
- Бизнес-метрики: Точность предсказания оттока (Precision), Полнота выявления (Recall)

## Результаты экспериментов

### 1. Сводная таблица по всем экспериментам

| Набор данных | Лучшая модель | PR-AUC | ROC-AUC | F1-Score | Precision | Recall | Accuracy | Разрыв CV/test (PR-AUC) |
|--------------|---------------|--------|---------|----------|-----------|--------|----------|-------------------------|
| **Unbalanced** | CatBoost | **0.660** | **0.842** | 0.581 | **0.669** | 0.513 | **0.803** | 0.017 |
| **Balanced Medium** | CatBoost | 0.644 | 0.837 | 0.627 | 0.532 | **0.765** | 0.758 | 0.03 |
| **Balanced** | Random Forest | 0.635 | 0.836 | **0.628** | 0.535 | 0.759 | 0.760 | 0.04 |

### 2. Детализация по наборам данных

#### 2.1 Набор данных: Unbalanced (Оригинальный)

**Результаты:**
- **Лучшая модель**: CatBoost (PR-AUC: 0.660, ROC-AUC: 0.842)
- **Особенности**: Наивысшая точность предсказания оттока (Precision: 0.669)
- **Проблема**: Низкая полнота (Recall: 0.513) - находит только 51.3% ушедших клиентов

**Анализ:**
- Минимальный разрыв между CV (0.677) и test (0.660) PR-AUC = 0.017
- Низкий риск переобучения
- Хорошая калибровка (Brier Score: 0.137, калибровка не потребовалась)

**Артефакты:**
- `../models/final_model_catboost_unbalanced.pkl`
- `../models/ensemble_forest_boosting_unbalanced.pkl`
- `../models/ensemble_forest_logistic_unbalanced.pkl`

#### 2.2 Набор данных: Balanced Medium (Средне-сбалансированный)

**Результаты:**
- **Лучшая модель**: CatBoost (PR-AUC: 0.644, ROC-AUC: 0.837)
- **Баланс метрик**: Хорошая полнота (Recall: 76.5%) с приемлемой точностью (Precision: 53.2%)
- **Калибровка**: Не потребовалась (базовая модель лучше)

**Анализ:**
- Маленький разрыв между CV (0.674) и test (0.644) PR-AUC = 0.030
- Высокая полнота выявления (Recall: 0.765)
- Наилучший F1-Score среди всех экспериментов (0.627)

**Артефакты:**
- `../models/final_model_catboost_balanced_medium.pkl`
- `../models/ensemble_forest_boosting_balanced_medium.pkl`
- `../models/ensemble_forest_logistic_balanced_medium.pkl`

#### 2.3 Набор данных: Balanced (Полностью сбалансированный)

**Результаты:**
- **Лучшая модель**: Random Forest (PR-AUC: 0.635, ROC-AUC: 0.836)
- **Наибольшая полнота**: Recall: 0.759 (находит 75.9% ушедших)
- **Наилучший F1-Score для сбалансированных данных**: 0.628

**Анализ:**
- Небольшой разрыв между CV (0.675) и test (0.635) PR-AUC = 0.040
- Высокая полнота с хорошей точностью
- Стабильная производительность

**Артефакты:**
- `../models/final_model_random_forest_balanced.pkl`
- `../models/ensemble_forest_boosting_balanced.pkl`
- `../models/ensemble_forest_logistic_balanced.pkl`

### 3. Анализ ансамблей


|Ансамбль|Набор данных|PR-AUC|ROC-AUC|F1-Score|Примечания|
|---|---|---|---|---|---|
|**Voting (RF + GB)**|Unbalanced|0.654|0.840|0.563|Незначительное улучшение PR-AUC|
|**Stacking (LR + RF)**|Unbalanced|0.658|0.841|0.570|Лучший среди ансамблей|
|**Voting (RF + GB)**|Balanced Medium|0.643|0.838|0.632|Практически идентично лучшей модели|
|**Stacking (LR + RF)**|Balanced Medium|0.646|0.840|0.633|Небольшое улучшение|
|**Voting (RF + GB)**|Balanced|0.636|0.836|0.628|Сопоставимо с лучшей моделью|
|**Stacking (LR + RF)**|Balanced|0.631|0.836|0.636|Улучшение F1-Score|

**Вывод по ансамблям:** Ансамбли не дали значительного улучшения PR-AUC относительно лучших одиночных моделей, но в некоторых случаях улучшили F1-Score. Stacking ансамбли показали немного лучшие результаты на несбалансированных данных.

## Протоколы экспериментов

### Протокол 1: Оптимизация гиперпараметров
- **Инструмент**: Optuna с TPESampler
- **Количество trials**: 50 для RF/GB, 30 для LightGBM, 15 для CatBoost
- **Целевая метрика**: **PR-AUC** на кросс-валидации
- **Стратегия**: Stratified 5-fold CV

### Протокол 2: Калибровка вероятностей
- **Методы**: Platt Scaling и Isotonic Regression
- **Валидация**: Hold-out validation set (20% от train)
- **Результат**: Калибровка не улучшила PR-AUC ни в одном эксперименте
- **Вывод**: Модели (особенно CatBoost) хорошо калиброваны изначально

### Протокол 3: Валидация устойчивости
- **Кросс-валидация**: 5-fold Stratified K-Fold
- **Стабильность**: Низкий std PR-AUC на CV (±0.004-0.024)
- **Воспроизводимость**: Фиксированный random_state=42

## Выбор финальной модели

### Критерии выбора:
1. **PR-AUC**: Основная метрика для задач с дисбалансом классов
2. **Баланс Precision/Recall**: Для бизнес-задачи важны обе метрики
3. **Стабильность**: Низкий разрыв между CV и test
4. **Бизнес-ценность**: Оптимальное соотношение затрат на удержание и покрытия оттока

### Сравнение кандидатов:


|Критерий|Unbalanced (CatBoost)|Balanced Medium (CatBoost)|Balanced (Random Forest)|
|---|---|---|---|
|**PR-AUC**|**0.660**|0.644|0.635|
|**ROC-AUC**|**0.842**|0.837|0.836|
|**Precision**|**0.669**|0.532|0.535|
|**Recall**|0.513|**0.765**|0.759|
|**F1-Score**|0.581|**0.627**|0.628|
|**Разрыв CV/test**|**0.017**|0.030|0.040|
|**Бизнес-ценность**|Минимум ложных срабатываний|Лучший баланс затрат/покрытия|Высокий охват оттока|


### Решение: **CatBoost на Balanced Medium данных**

**Обоснование:**
1. **Оптимальный баланс метрик**: F1-Score = 0.627, хороший компромисс между Precision (53.2%) и Recall (76.5%)
2. **Приемлемое качество ранжирования**: PR-AUC = 0.644 (близко к лучшему результату)
3. **Высокая полнота выявления**: Находит 76.5% ушедших клиентов (на 25% больше, чем Unbalanced)
4. **Достаточная точность**: Precision = 0.532 (приемлемо для бизнеса при таком высоком Recall)
5. **Хорошая ROC-AUC**: 0.837 (выше минимального требования 0.75)

**Финальная модель:** `../models/final_model_catboost_balanced_medium.pkl`

### Альтернативный вариант для минимизации затрат:
Если бизнес ставит целью **минимизацию расходов на удержание** и готов мириться с потерей части оттока, рекомендуется модель **CatBoost на Unbalanced данных** (`../models/final_model_catboost_unbalanced.pkl`), которая обеспечивает максимальную точность прогнозов (66.9%).

## Артефакты эксперимента

### Данные:
- Исходные данные: `../data/processed/`
- Предобработанные данные: `../data/processed/train_*.csv`, `../data/processed/test.csv`

## Выводы

1. **CatBoost показал наилучшие результаты** в двух из трех экспериментов (Unbalanced и Balanced Medium)
2. **Балансировка данных значительно улучшает Recall**, но снижает Precision и увеличивает риск переобучения
3. **Средняя балансировка (Balanced Medium)** дает оптимальный компромисс между метриками и стабильностью
4. **Калибровка не потребовалась** - современные алгоритмы (особенно CatBoost) хорошо калиброваны изначально
5. **Требования по ROC-AUC выполнены**: Все модели > 0.75 (минимальное проектное требование)

**Рекомендация для бизнеса:** 
- **Основная рекомендация**: Использовать CatBoost модель на средне-сбалансированных данных для оптимального баланса между выявлением оттока и точностью прогнозов
- **Дополнительная настройка**: Регулировать порог классификации для смещения баланса Precision/Recall в зависимости от текущих бизнес-приоритетов и бюджета на удержание
- **Мониторинг**: Регулярно переоценивать модель с учетом изменения поведения клиентов и бизнес-стратегии